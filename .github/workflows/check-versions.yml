name: Check Upstream Versions

on:
  schedule:
    - cron: "0 0 * * 1" # Weekly on Monday at midnight UTC
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || github.token }}

      - name: Check Trufflehog version
        id: trufflehog
        run: |
          CURRENT_VERSION=$(grep -oP 'v\d+\.\d+\.\d+' Trufflehog-Kasm/Dockerfile | head -1)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/trufflesecurity/trufflehog/releases/latest | jq -r .tag_name)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Trufflehog update available: $CURRENT_VERSION → $LATEST_VERSION"
            # Auto-update Dockerfile
            sed -i "s|sh -s -- -b /usr/local/bin $CURRENT_VERSION|sh -s -- -b /usr/local/bin $LATEST_VERSION|g" Trufflehog-Kasm/Dockerfile
            sed -i "s|# ─── Install TruffleHog $CURRENT_VERSION|# ─── Install TruffleHog $LATEST_VERSION|g" Trufflehog-Kasm/Dockerfile
          fi

      - name: Check SocialAnalyzer version
        id: socialanalyzer
        run: |
          # SocialAnalyzer uses main branch (no releases), skip auto-update
          echo "current=main" >> $GITHUB_OUTPUT
          echo "latest=main" >> $GITHUB_OUTPUT

      - name: Check Webcheck version
        id: webcheck
        run: |
          CURRENT_VERSION=$(grep -oP 'branch \K\d+\.\d+\.\d+' Webcheck-Kasm/Dockerfile | head -1)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/Lissy93/web-check/releases/latest | jq -r .tag_name)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Webcheck update available: $CURRENT_VERSION → $LATEST_VERSION"
            # Auto-update Dockerfile
            sed -i "s|--branch $CURRENT_VERSION|--branch $LATEST_VERSION|g" Webcheck-Kasm/Dockerfile
          fi

      - name: Check Hayabusa version (Takajo component)
        id: hayabusa
        run: |
          CURRENT_VERSION=$(grep -oP 'hayabusa/releases/download/v\K\d+\.\d+\.\d+' Takajo-Kasm/Dockerfile | head -1)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/Yamato-Security/hayabusa/releases/latest | jq -r .tag_name | sed 's/^v//')
          echo "current=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest=v$LATEST_VERSION" >> $GITHUB_OUTPUT
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Hayabusa update available: v$CURRENT_VERSION → v$LATEST_VERSION"
            # Auto-update Dockerfile
            sed -i "s|hayabusa/releases/download/v$CURRENT_VERSION/hayabusa-$CURRENT_VERSION|hayabusa/releases/download/v$LATEST_VERSION/hayabusa-$LATEST_VERSION|g" Takajo-Kasm/Dockerfile
          fi

      - name: Check Chainsaw version (Takajo component)
        id: chainsaw
        run: |
          CURRENT_VERSION=$(grep -oP 'chainsaw/releases/download/v\K\d+\.\d+\.\d+' Takajo-Kasm/Dockerfile | head -1)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/WithSecureLabs/chainsaw/releases/latest | jq -r .tag_name | sed 's/^v//')
          echo "current=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest=v$LATEST_VERSION" >> $GITHUB_OUTPUT
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Chainsaw update available: v$CURRENT_VERSION → v$LATEST_VERSION"
            # Auto-update Dockerfile
            sed -i "s|chainsaw/releases/download/v$CURRENT_VERSION/|chainsaw/releases/download/v$LATEST_VERSION/|g" Takajo-Kasm/Dockerfile
          fi

      - name: Check Epagneul version
        id: epagneul
        run: |
          CURRENT_VERSION=$(grep -oP '\d+\.\d+\.\d+' Epagneul-Kasm/Dockerfile | head -1)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/jurelou/epagneul/releases/latest | jq -r .tag_name)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Epagneul update available: $CURRENT_VERSION → $LATEST_VERSION"
            # Auto-update Dockerfile
            sed -i "s|--branch $CURRENT_VERSION|--branch $LATEST_VERSION|g" Epagneul-Kasm/Dockerfile
          fi

      - name: Check Slasher commits
        id: slasher
        run: |
          CURRENT_COMMIT=$(grep -oP 'git checkout \K[a-f0-9]{40}' Slasher-Kasm/Dockerfile | head -1)
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/hexastrike/slasher/commits/main | jq -r .sha)
          CURRENT_SHORT="${CURRENT_COMMIT:0:7}"
          LATEST_SHORT="${LATEST_COMMIT:0:7}"
          echo "current=$CURRENT_SHORT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_SHORT" >> $GITHUB_OUTPUT
          echo "current_full=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "latest_full=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          if [ "$CURRENT_COMMIT" != "$LATEST_COMMIT" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Slasher update available: $CURRENT_SHORT → $LATEST_SHORT"
            # Auto-update Dockerfile
            sed -i "s|git checkout $CURRENT_COMMIT|git checkout $LATEST_COMMIT|g" Slasher-Kasm/Dockerfile
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No version updates needed"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Version updates detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Build commit message
          echo "chore: Auto-update application versions" > commit_msg.txt
          echo "" >> commit_msg.txt
          echo "Updated versions:" >> commit_msg.txt

          if [ "${{ steps.trufflehog.outputs.update_available }}" == "true" ]; then
            echo "- Trufflehog: ${{ steps.trufflehog.outputs.current }} to ${{ steps.trufflehog.outputs.latest }}" >> commit_msg.txt
          fi

          if [ "${{ steps.webcheck.outputs.update_available }}" == "true" ]; then
            echo "- Webcheck: ${{ steps.webcheck.outputs.current }} to ${{ steps.webcheck.outputs.latest }}" >> commit_msg.txt
          fi

          if [ "${{ steps.hayabusa.outputs.update_available }}" == "true" ]; then
            echo "- Hayabusa: ${{ steps.hayabusa.outputs.current }} to ${{ steps.hayabusa.outputs.latest }}" >> commit_msg.txt
          fi

          if [ "${{ steps.chainsaw.outputs.update_available }}" == "true" ]; then
            echo "- Chainsaw: ${{ steps.chainsaw.outputs.current }} to ${{ steps.chainsaw.outputs.latest }}" >> commit_msg.txt
          fi

          if [ "${{ steps.epagneul.outputs.update_available }}" == "true" ]; then
            echo "- Epagneul: ${{ steps.epagneul.outputs.current }} to ${{ steps.epagneul.outputs.latest }}" >> commit_msg.txt
          fi

          if [ "${{ steps.slasher.outputs.update_available }}" == "true" ]; then
            echo "- Slasher: ${{ steps.slasher.outputs.current }} to ${{ steps.slasher.outputs.latest }}" >> commit_msg.txt
          fi

          echo "" >> commit_msg.txt
          echo "Automated update by check-versions workflow" >> commit_msg.txt

          git add -A
          git commit -F commit_msg.txt
          git push

      - name: Create summary
        run: |
          echo "# Version Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | Current | Latest | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trufflehog | ${{ steps.trufflehog.outputs.current }} | ${{ steps.trufflehog.outputs.latest }} | ${{ steps.trufflehog.outputs.update_available == 'true' && 'Auto-Updated' || 'Up to Date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SocialAnalyzer | ${{ steps.socialanalyzer.outputs.current }} | ${{ steps.socialanalyzer.outputs.latest }} | Uses Main Branch |" >> $GITHUB_STEP_SUMMARY
          echo "| Webcheck | ${{ steps.webcheck.outputs.current }} | ${{ steps.webcheck.outputs.latest }} | ${{ steps.webcheck.outputs.update_available == 'true' && 'Auto-Updated' || 'Up to Date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hayabusa | ${{ steps.hayabusa.outputs.current }} | ${{ steps.hayabusa.outputs.latest }} | ${{ steps.hayabusa.outputs.update_available == 'true' && 'Auto-Updated' || 'Up to Date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chainsaw | ${{ steps.chainsaw.outputs.current }} | ${{ steps.chainsaw.outputs.latest }} | ${{ steps.chainsaw.outputs.update_available == 'true' && 'Auto-Updated' || 'Up to Date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Epagneul | ${{ steps.epagneul.outputs.current }} | ${{ steps.epagneul.outputs.latest }} | ${{ steps.epagneul.outputs.update_available == 'true' && 'Auto-Updated' || 'Up to Date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Slasher | ${{ steps.slasher.outputs.current }} | ${{ steps.slasher.outputs.latest }} | ${{ steps.slasher.outputs.update_available == 'true' && 'Auto-Updated' || 'Up to Date' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "## Automatic Updates Applied" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Dockerfiles have been automatically updated and committed." >> $GITHUB_STEP_SUMMARY
            echo "Build workflows will automatically trigger to rebuild and push updated containers to Docker Hub." >> $GITHUB_STEP_SUMMARY
          else
            echo "## All Applications Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No updates were needed. All applications are running the latest versions." >> $GITHUB_STEP_SUMMARY
          fi
